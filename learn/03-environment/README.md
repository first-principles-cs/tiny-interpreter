# 模块 3：环境模型 (Environment)

> "变量的值存在哪里？"

## 问题引入

考虑这段代码：

```lisp
(define x 10)
(define y 20)
(+ x y)  ; 应该得到 30
```

当我们执行 `(+ x y)` 时，需要知道 `x` 和 `y` 的值。

**问题**：这些值存在哪里？如何查找？

---

## 更复杂的情况

```lisp
(define x 10)

(define f
  (lambda (x)
    (+ x 1)))

(f 5)  ; 结果是什么？6 还是 11？
```

这里有两个 `x`：
- 外部的 `x = 10`
- 函数参数 `x = 5`

**问题**：函数内部的 `x` 应该是哪个？

答案：**5**。函数参数"遮蔽"了外部变量。

---

## 核心概念

### 环境是什么？

环境是一个**变量名到值的映射**，加上一个**指向父环境的引用**。

```
┌─────────────────────┐
│ 全局环境            │
│ x → 10              │
│ y → 20              │
│ f → <closure>       │
└─────────────────────┘
         ↑
         │ parent
┌─────────────────────┐
│ 函数环境            │
│ x → 5               │  ← 遮蔽了全局的 x
└─────────────────────┘
```

### 变量查找规则

1. 在当前环境中查找
2. 如果找不到，在父环境中查找
3. 一直向上，直到找到或到达顶层
4. 如果顶层也没有，报错"未定义变量"

这就是**词法作用域**（Lexical Scoping）。

### 三个核心操作

| 操作 | 说明 | 示例 |
|------|------|------|
| `define(name, value)` | 在当前环境定义变量 | `(define x 10)` |
| `get(name)` | 查找变量值 | 求值 `x` |
| `set(name, value)` | 修改已存在的变量 | `(set! x 20)` |

---

## 关键不变量

1. **词法作用域**：变量查找遵循代码的静态结构，而不是运行时调用栈
2. **遮蔽规则**：内层环境的变量遮蔽外层同名变量
3. **define vs set**：`define` 在当前环境创建，`set` 修改已存在的变量

---

## 动手实现

### 步骤 1：理解骨架代码

打开 `skeleton.py`，你会看到：

```python
class Environment:
    def __init__(self, parent=None):
        self.bindings = {}
        self.parent = parent

    def define(self, name, value):
        # TODO
        pass

    def get(self, name):
        # TODO
        pass
```

### 步骤 2：实现核心方法

你需要实现：

1. `define(name, value)` - 在当前环境定义变量
2. `get(name)` - 查找变量值（需要向上查找父环境）
3. `set(name, value)` - 修改已存在的变量

### 步骤 3：运行测试

```bash
cd tiny-interpreter
pytest learn/03-environment/test_skeleton.py -v
```

---

## 可视化

让我们看看环境链是如何工作的：

```lisp
(define x 10)
(define f (lambda (y) (+ x y)))
(f 5)
```

执行过程：

```
1. 创建全局环境
   ┌─────────────┐
   │ x → 10      │
   │ f → closure │
   └─────────────┘

2. 调用 (f 5)，创建函数环境
   ┌─────────────┐
   │ x → 10      │
   │ f → closure │
   └─────────────┘
         ↑
   ┌─────────────┐
   │ y → 5       │  ← 当前环境
   └─────────────┘

3. 求值 (+ x y)
   - 查找 x：当前环境没有 → 父环境找到 x=10
   - 查找 y：当前环境找到 y=5
   - 结果：15
```

---

## 提示

如果卡住了，可以查看提示：

- [提示 1：define 和 get](hints/hint1.md)
- [提示 2：向上查找](hints/hint2.md)
- [提示 3：set 的实现](hints/hint3.md)

---

## 深入思考

完成实现后，思考这些问题（详见 [challenge.md](challenge.md)）：

1. 为什么需要 `parent` 引用？能不能用其他方式？
2. `set` 和 `define` 的区别是什么？
3. 如果允许删除变量，会有什么问题？

---

## 下一步

现在我们有了存储变量的地方。

接下来，让我们实现求值器，把 AST 和环境结合起来！

[进入模块 4：基础求值 →](../04-evaluator-basic/README.md)
