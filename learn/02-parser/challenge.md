# 挑战题：语法分析

## 挑战 1：错误处理

当前实现遇到错误就停止。考虑这些情况：

```lisp
(+ 1 2          ; 缺少右括号
(+ 1 2))        ; 多余的右括号
(+ 1 (2 3))     ; 语法正确但语义可能有问题
```

**问题**：
1. 如何提供有意义的错误信息？
2. 错误信息应该包含什么？（行号、列号、期望什么、实际是什么）
3. 能否在一次解析中报告多个错误？

---

## 挑战 2：运算符优先级

我们的语言使用前缀表示法，不需要处理优先级：

```lisp
(+ 1 (* 2 3))   ; 明确：先算 2*3，再加 1
```

但如果要支持中缀表示法：

```
1 + 2 * 3       ; 应该是 1 + (2 * 3) = 7
```

**问题**：
1. 如何处理运算符优先级？
2. 如何处理结合性（左结合 vs 右结合）？
3. 研究一下 Pratt Parser 是什么。

---

## 挑战 3：语法糖

很多语言有"语法糖"——更方便的写法：

```lisp
; 当前写法
(define square (lambda (x) (* x x)))

; 语法糖
(define (square x) (* x x))
```

**问题**：
1. 这种转换应该在哪里做？Parser 还是后面？
2. 如何修改 Parser 支持这种语法？
3. 还有什么其他语法糖可以添加？

---

## 挑战 4：Quote 的特殊性

`quote` 是特殊的——它阻止求值：

```lisp
(quote (+ 1 2))  ; 返回列表 (+ 1 2)，不是 3
'(+ 1 2)         ; 简写形式
```

**问题**：
1. `'` 应该在 Lexer 还是 Parser 处理？
2. 如何把 `'(+ 1 2)` 转换成 `(quote (+ 1 2))`？
3. 嵌套的 quote 怎么处理？`''x`

---

## 挑战 5：位置信息传播

当前 AST 节点保存了位置信息。但考虑：

```lisp
(define x
  (+ 1
     2))
```

**问题**：
1. `SExpression` 的位置应该是什么？开始的 `(` 还是整个范围？
2. 如何在错误信息中显示代码片段？
3. 如何实现"点击错误跳转到源码"的功能？

---

## 挑战 6：增量解析

如果用户在编辑器中修改了一个字符，需要重新解析整个文件吗？

**问题**：
1. 什么是增量解析？
2. 如何只重新解析改变的部分？
3. 研究一下 Tree-sitter 是如何做的。

---

## 延伸阅读

- [Crafting Interpreters - Parsing Expressions](https://craftinginterpreters.com/parsing-expressions.html)
- [Pratt Parsing](https://matklad.github.io/2020/04/13/simple-but-powerful-pratt-parsing.html)
- [Tree-sitter](https://tree-sitter.github.io/tree-sitter/)
